name: Deploy Splunk Rules
on:
  push:
    paths:
      - 'rules/**/**' #gli "**" per indicare indicare la ricorsivit√†


jobs:

  sigma_validate: #nome del job
    runs-on: self-hosted #per fare comunicare github con il server splunk locale

    steps:
      - uses: actions/checkout@v6 #@v6 indica la versione, controllata su https://github.com/marketplace/actions/checkout
      #serve per caricare i contenuti del mio repo nel runner (quindi le rules e scripts) nel runner
      - run: pip install check-jsonschema
      - run: |
          curl -o sigma-schema.json https://raw.githubusercontent.com/SigmaHQ/sigma-specification/main/sigma-schema.json
          check-jsonschema --schemafile sigma-schema.json rules/**/**/
      #serve per validare le Sigma rules con sigma-schema.json presente su SigmaHQ

  splunk_deploy: #nome del job
    needs: sigma_validate #per non fare eseguire il job in parallelo, indico che deve prima terminare con successo il primo
    #ossia la validazione della regola deve terminare con successo:
    runs-on: self-hosted #per fare comunicare github con il server splunk locale
    container: python:3.13-slim
    
    steps:
      - uses: actions/checkout@v6 #@v6 indica la versione, controllata su https://github.com/marketplace/actions/checkout

      - run: pip install pysigma pysigma-backend-splunk
      
      - run: python scripts/Sigma-SPLconverter.py
        env: #lo script in python carica le variabili di sistema per url e token di splunk, quindi li carico dai secrets
            SPLUNK_HOST: ${{ secrets.SPLUNK_HOST }}
            SPLUNK_TOKEN: ${{ secrets.SPLUNK_TOKEN }}
            

    
